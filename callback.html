<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticando - Tuneuptify</title>
    <meta name="description" content="Procesando autenticación de Spotify">
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
        img-src 'self' data: https:;
        connect-src 'self' https://accounts.spotify.com https://api.spotify.com https://www.google.com;
        frame-src 'self' https://accounts.spotify.com;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Estilos -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        .callback-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-gradient);
            position: relative;
            overflow: hidden;
        }
        
        .callback-card {
            background: var(--bg-glass);
            border-radius: var(--radius-2xl);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-xl);
            padding: var(--space-2xl);
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: fadeInUp 1s ease-out;
        }
        
        .callback-icon {
            font-size: 4rem;
            color: var(--accent-gold);
            margin-bottom: var(--space-lg);
            animation: pulse 2s ease-in-out infinite;
        }
        
        .callback-title {
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-md);
        }
        
        .callback-message {
            color: var(--text-secondary);
            font-size: var(--text-base);
            margin-bottom: var(--space-xl);
        }
        
        .callback-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(244, 208, 63, 0.3);
            border-top: 3px solid var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-lg);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .callback-error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            margin-top: var(--space-lg);
        }
        
        .callback-success {
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border: 1px solid rgba(39, 174, 96, 0.3);
            padding: var(--space-md);
            border-radius: var(--radius-lg);
            margin-top: var(--space-lg);
        }
    </style>
</head>
<body>
    <div class="callback-container">
        <div class="callback-card">
            <div class="callback-icon">
                <i class="fab fa-spotify"></i>
            </div>
            <h1 class="callback-title">Procesando autenticación</h1>
            <p class="callback-message">Estamos conectando tu cuenta de Spotify...</p>
            <div class="callback-spinner"></div>
            <div id="callback-status"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script>
        // Procesar la autenticación cuando la página se carga
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const tokenFromUrl = urlParams.get('access_token');
            const error = urlParams.get('error');
            const state = urlParams.get('state');
            
            const statusElement = document.getElementById('callback-status');
            
            console.log('URL Parameters:', {
                code: code,
                access_token: tokenFromUrl,
                error: error,
                state: state
            });
            
            if (error) {
                statusElement.innerHTML = `
                    <div class="callback-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        Error de autorización: ${error}
                    </div>
                `;
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                return;
            }
            
            if (tokenFromUrl) {
                // Token directo en URL (Implicit Grant)
                try {
                    localStorage.setItem('spotify_access_token', tokenFromUrl);
                    localStorage.removeItem('spotify_auth_state');
                    
                    statusElement.innerHTML = `
                        <div class="callback-success">
                            <i class="fas fa-check-circle"></i>
                            ¡Autenticación exitosa!
                        </div>
                    `;
                    
                    setTimeout(() => {
                        window.location.href = 'pages/dashboard.html';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error processing token:', error);
                    statusElement.innerHTML = `
                        <div class="callback-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            Error al procesar la autenticación
                        </div>
                    `;
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                }
            } else if (code) {
                // Código de autorización recibido (Authorization Code Flow)
                statusElement.innerHTML = `
                    <div class="callback-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        Se recibió un código de autorización, pero necesitamos un token directo.<br>
                        Por favor, verifica la configuración de la aplicación de Spotify.
                    </div>
                `;
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 5000);
            } else {
                // No hay parámetros de autenticación válidos
                statusElement.innerHTML = `
                    <div class="callback-error">
                        <i class="fas fa-exclamation-triangle"></i>
                        No se encontraron parámetros de autenticación válidos<br>
                        URL actual: ${window.location.href}
                    </div>
                `;
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 5000);
            }
        });
    </script>
</body>
</html> 