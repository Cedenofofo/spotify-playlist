<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuneuptify - Autenticación</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https: data:; img-src 'self' data: https: blob:; connect-src 'self' https: wss:; frame-src 'self' https:; object-src 'none'; base-uri 'self'; form-action 'self';">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 2rem;
        }
        .auth-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(29, 185, 84, 0.3);
            border-top: 4px solid #1db954;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .auth-message {
            font-size: 1.2rem;
            color: #ffffff;
            margin-bottom: 1rem;
        }
        .auth-error {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-spinner"></div>
        <div class="auth-message" id="auth-message">Procesando autenticación...</div>
        <div id="auth-error" class="auth-error" style="display: none;"></div>
    </div>

    <script src="js/cache-cleaner.js?v=1.0.1"></script>
    <script>
        // Configuración de Spotify
        const SPOTIFY_CONFIG = {
            clientId: '87cd9c6748524a58bc0e3151a3173e93',
            clientSecret: '5c0c9086ef2a414d93e7e9385390053b',
            redirectUri: window.location.hostname.includes('github.io')
                ? 'https://cedenofofo.github.io/spotify-playlist/callback.html'
                : 'http://localhost:8000/callback.html'
        };

        // Función para obtener parámetros de la URL
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Función para manejar errores
        function handleError(message) {
            document.getElementById('auth-message').textContent = 'Error en la autenticación';
            document.getElementById('auth-error').textContent = message;
            document.getElementById('auth-error').style.display = 'block';
        }

        // Función para intercambiar código por token
        async function exchangeCodeForToken(code) {
            try {
                document.getElementById('auth-message').textContent = 'Intercambiando código por token...';
                
                // Crear las credenciales codificadas en base64
                const credentials = btoa(SPOTIFY_CONFIG.clientId + ':' + SPOTIFY_CONFIG.clientSecret);
                
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + credentials
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: SPOTIFY_CONFIG.redirectUri
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = `Error ${response.status}: ${errorData.error_description || errorData.error || 'Error desconocido'}`;
                    
                    // Mensajes de error específicos
                    switch (response.status) {
                        case 400:
                            errorMessage = 'Código de autorización inválido o expirado. Por favor, intenta de nuevo.';
                            break;
                        case 401:
                            errorMessage = 'Credenciales de aplicación inválidas. Contacta al administrador.';
                            break;
                        case 403:
                            errorMessage = 'Acceso denegado. Verifica los permisos de la aplicación.';
                            break;
                        case 429:
                            errorMessage = 'Demasiadas solicitudes. Espera un momento antes de intentar de nuevo.';
                            break;
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();

                if (data.access_token) {
                    // Guardar tokens
                    localStorage.setItem('spotify_access_token', data.access_token);
                    localStorage.setItem('spotify_token_expires', Date.now() + (data.expires_in * 1000));
                    
                    if (data.refresh_token) {
                        localStorage.setItem('spotify_refresh_token', data.refresh_token);
                    }

                    document.getElementById('auth-message').textContent = '¡Autenticación exitosa! Redirigiendo...';
                    
                    // Redirigir al dashboard
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1000);
                } else {
                    throw new Error('No se recibió el token de acceso');
                }
            } catch (error) {
                console.error('Error:', error);
                handleError('Error al obtener el token de acceso: ' + error.message);
                
                // Redirigir a la página principal después de 5 segundos
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 5000);
            }
        }

        // Función principal de autenticación
        function handleAuthentication() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const error = urlParams.get('error');

            // Si hay un error
            if (error) {
                handleError('Error de autorización: ' + error);
                return;
            }

            // Si no hay código
            if (!code) {
                handleError('No se recibió el código de autorización');
                return;
            }

            // Verificar el estado si es necesario
            const storedState = localStorage.getItem('spotify_auth_state');
            if (state && storedState && state !== storedState) {
                handleError('Estado de seguridad inválido');
                return;
            }

            // Intercambiar código por token
            exchangeCodeForToken(code);
        }

        // Ejecutar cuando la página cargue
        document.addEventListener('DOMContentLoaded', handleAuthentication);
    </script>
</body>
</html> 