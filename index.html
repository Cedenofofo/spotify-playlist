<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuneuptify</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/search.css">
    <link rel="stylesheet" href="css/inline-styles.css">

</head>
<body>
    <header role="banner" aria-label="Tuneuptify logo y título">
        <img src="img/tuneuptify-logo.png" alt="Logo Tuneuptify" class="logo-tuneuptify" width="180" height="auto" />
        <h1>Tuneuptify</h1>
    </header>
    <main id="main-content" tabindex="-1" aria-label="Generador de Playlist de Spotify">
    <div class="container" role="main">
        <div id="login-section" class="login-section">
            <p>Para comenzar, inicia sesión con tu cuenta de Spotify</p>
            <button id="login-button" class="spotify-button" aria-label="Iniciar sesión con Spotify">
                <i class="fab fa-spotify" aria-hidden="true"></i> Iniciar sesión con Spotify
            </button>
        </div>
        <div id="playlist-section" class="playlist-section" style="display: none;">
            <div style="text-align: right; margin-bottom: 20px;">
                <button type="button" id="logout-button" class="spotify-button secondary" aria-label="Cerrar sesión">
                    <i class="fas fa-sign-out-alt" aria-hidden="true"></i> Cerrar sesión
                </button>
            </div>
            <form id="playlist-form" aria-label="Formulario para crear playlist">
                <label for="playlist-name">Nombre de la playlist:</label>
                <input type="text" id="playlist-name" required placeholder="Mi Playlist personalizada" aria-required="true" aria-label="Nombre de la playlist">
                <label for="artist-main">Artista principal:</label>
                <div style="position:relative;">
                  <input type="text" id="artist-main" name="artist-main" class="artist-autocomplete" placeholder="Nombre del artista principal" autocomplete="off" aria-autocomplete="list" aria-label="Buscar artista principal">
                  <div id="artist-main-suggestions" class="autocomplete-suggestions" role="listbox"></div>
                </div>
                <label>Artistas adicionales:</label>
                <div id="artist-inputs" class="artist-inputs"></div>
                <button type="button" id="add-artist" class="add-artist-btn" aria-label="Agregar artista adicional"><i class="fas fa-plus" aria-hidden="true"></i> Agregar artista</button>
                <label for="songs-per-artist">Canciones por artista:</label>
                <input type="number" id="songs-per-artist" min="1" max="50" value="5" step="1" required aria-required="true" aria-label="Número de canciones por artista">
                <label for="track-search">Agregar canciones específicas:</label>
                <div style="position:relative;">
                  <input type="text" id="track-search" placeholder="Buscar canciones..." autocomplete="off" aria-autocomplete="list" aria-label="Buscar canciones específicas">
                  <div id="search-suggestions" class="autocomplete-suggestions" role="listbox"></div>
                </div>
                <h3>Canciones seleccionadas:</h3>
                <div id="selected-tracks"></div>
                <button type="button" id="preview-playlist" class="spotify-button" aria-label="Vista previa de la playlist"><i class="fas fa-eye" aria-hidden="true"></i> Vista previa</button>
            </form>
            <div id="playlist-preview" class="playlist-preview" style="display:none;"></div>
            <button id="export-spotify" class="spotify-button spotify-black" style="display:none;"><i class="fab fa-spotify" aria-hidden="true"></i> Exportar a Spotify</button>
            <div id="loading" class="loading-spinner" style="display: none;">
                <div class="spinner" aria-hidden="true"></div>
                <p>Creando playlist...</p>
            </div>
            <div id="success-message" class="success-message" style="display: none;"></div>
        </div>
    </div>
    </main>
    <footer style="text-align:center; margin-top:32px; color:#b3b3b3; font-size:0.95em;" aria-label="Pie de página">
        <p>&copy; 2024 Tuneuptify. Todos los derechos reservados.</p>
    </footer>
    <script src="js/config.js"></script>
    <script>
    // --- PKCE utilidades ---
    async function generateCodeVerifier() {
        const array = new Uint8Array(64);
        window.crypto.getRandomValues(array);
        return btoa(String.fromCharCode.apply(null, array)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '').substring(0, 128);
    }
    async function generateCodeChallenge(codeVerifier) {
        const encoder = new TextEncoder();
        const data = encoder.encode(codeVerifier);
        const digest = await window.crypto.subtle.digest('SHA-256', data);
        let base64 = btoa(String.fromCharCode(...new Uint8Array(digest)));
        return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }
    function getRandomState() {
        return Array.from(window.crypto.getRandomValues(new Uint8Array(16))).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si el usuario ya está autenticado
        const accessToken = localStorage.getItem('spotify_access_token');
        const loginSection = document.getElementById('login-section');
        const playlistSection = document.getElementById('playlist-section');
        
        if (accessToken) {
            // Usuario autenticado, mostrar la interfaz de playlist
            loginSection.style.display = 'none';
            playlistSection.style.display = 'block';
            console.log('Usuario autenticado, mostrando interfaz de playlist');
        } else {
            // Usuario no autenticado, mostrar botón de login
            loginSection.style.display = 'block';
            playlistSection.style.display = 'none';
            console.log('Usuario no autenticado, mostrando botón de login');
        }
        
        const loginBtn = document.getElementById('login-button');
        if (loginBtn) {
            loginBtn.addEventListener('click', async function() {
                const codeVerifier = await generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                const state = getRandomState();
                localStorage.setItem('spotify_auth_state', state);
                localStorage.setItem('spotify_pkce_code_verifier', codeVerifier);
                console.log('Debug - redirectUri:', config.redirectUri);
                console.log('Debug - clientId:', config.clientId);
                
                const params = new URLSearchParams({
                    client_id: config.clientId,
                    response_type: 'code',
                    redirect_uri: config.redirectUri,
                    code_challenge_method: 'S256',
                    code_challenge: codeChallenge,
                    state: state,
                    scope: config.scopes.join(' '),
                    show_dialog: 'true'
                });
                
                const authUrl = `${config.authUrl}?${params.toString()}`;
                console.log('Debug - authUrl:', authUrl);
                window.location.href = authUrl;
            });
        }
        
        // Funcionalidad del botón de logout
        const logoutBtn = document.getElementById('logout-button');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                // Limpiar todos los datos de autenticación
                localStorage.removeItem('spotify_access_token');
                localStorage.removeItem('spotify_auth_state');
                localStorage.removeItem('spotify_pkce_code_verifier');
                
                // Recargar la página para mostrar el botón de login
                window.location.reload();
            });
        }
    });
    </script>
    <script src="js/auth.js"></script>
    <script src="js/search.js"></script>
    <script src="js/main.js"></script>
</body>
</html> 