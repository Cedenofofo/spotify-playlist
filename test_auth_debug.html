<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Autenticaci√≥n - Tuneuptify</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            padding: 2rem;
            margin: 0;
        }
        .debug-container {
            max-width: 800px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 2rem;
            border-radius: 12px;
            border: 1px solid #333;
        }
        .debug-section {
            margin-bottom: 2rem;
            padding: 1rem;
            background: #333;
            border-radius: 8px;
        }
        .debug-title {
            color: #1db954;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        .debug-info {
            background: #444;
            padding: 1rem;
            border-radius: 6px;
            margin: 0.5rem 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .debug-button {
            background: #1db954;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin: 0.5rem;
            font-size: 1rem;
        }
        .debug-button:hover {
            background: #1ed760;
        }
        .debug-button.danger {
            background: #e74c3c;
        }
        .debug-button.danger:hover {
            background: #c0392b;
        }
        .status {
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
        }
        .status.success {
            background: rgba(29, 185, 84, 0.2);
            border: 1px solid #1db954;
            color: #1db954;
        }
        .status.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }
        .status.warning {
            background: rgba(243, 156, 18, 0.2);
            border: 1px solid #f39c12;
            color: #f39c12;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üîç Debug de Autenticaci√≥n - Tuneuptify</h1>
        
        <div class="debug-section">
            <h2 class="debug-title">üìã Estado Actual</h2>
            <div id="current-status"></div>
        </div>
        
        <div class="debug-section">
            <h2 class="debug-title">‚öôÔ∏è Configuraci√≥n</h2>
            <div id="config-status"></div>
        </div>
        
        <div class="debug-section">
            <h2 class="debug-title">üîë Tokens</h2>
            <div id="tokens-status"></div>
        </div>
        
        <div class="debug-section">
            <h2 class="debug-title">üåê Conectividad</h2>
            <div id="network-status"></div>
        </div>
        
        <div class="debug-section">
            <h2 class="debug-title">üß™ Pruebas</h2>
            <button class="debug-button" onclick="testConfig()">Probar Configuraci√≥n</button>
            <button class="debug-button" onclick="testNetwork()">Probar Conectividad</button>
            <button class="debug-button" onclick="testAuth()">Probar Autenticaci√≥n</button>
            <button class="debug-button danger" onclick="clearTokens()">Limpiar Tokens</button>
            <button class="debug-button" onclick="refreshPage()">üîÑ Recargar</button>
        </div>
        
        <div class="debug-section">
            <h2 class="debug-title">üìù Logs</h2>
            <div id="logs" class="debug-info"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let logs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            logs.unshift(logEntry);
            
            // Mantener solo los √∫ltimos 50 logs
            if (logs.length > 50) logs = logs.slice(0, 50);
            
            document.getElementById('logs').textContent = logs.join('\n');
            console.log(logEntry);
        }
        
        function updateStatus(elementId, content, className = '') {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            if (className) {
                element.className = `status ${className}`;
            }
        }
        
        function checkCurrentStatus() {
            log('Verificando estado actual...');
            
            // Estado general
            const isLoggedIn = !!localStorage.getItem('spotify_access_token');
            const tokenExpires = localStorage.getItem('spotify_token_expires');
            const isExpired = tokenExpires && Date.now() > parseInt(tokenExpires);
            
            let statusHtml = '';
            if (isLoggedIn && !isExpired) {
                statusHtml = '‚úÖ Usuario autenticado y token v√°lido';
                updateStatus('current-status', statusHtml, 'success');
            } else if (isLoggedIn && isExpired) {
                statusHtml = '‚ö†Ô∏è Usuario autenticado pero token expirado';
                updateStatus('current-status', statusHtml, 'warning');
            } else {
                statusHtml = '‚ùå Usuario no autenticado';
                updateStatus('current-status', statusHtml, 'error');
            }
            
            log(`Estado: ${statusHtml}`);
        }
        
        function checkConfig() {
            log('Verificando configuraci√≥n...');
            
            let configHtml = '';
            if (window.config) {
                configHtml = `
                    ‚úÖ Configuraci√≥n cargada correctamente
                    Client ID: ${window.config.clientId ? '‚úÖ' : '‚ùå'}
                    Client Secret: ${window.config.clientSecret ? '‚úÖ' : '‚ùå'}
                    Redirect URI: ${window.config.redirectUri ? '‚úÖ' : '‚ùå'}
                    Auth URL: ${window.config.authUrl ? '‚úÖ' : '‚ùå'}
                    Scopes: ${window.config.scopes ? window.config.scopes.length : 0} permisos
                `;
                updateStatus('config-status', configHtml, 'success');
                log('Configuraci√≥n v√°lida');
            } else {
                configHtml = '‚ùå Configuraci√≥n no disponible';
                updateStatus('config-status', configHtml, 'error');
                log('Configuraci√≥n no disponible', 'error');
            }
        }
        
        function checkTokens() {
            log('Verificando tokens...');
            
            const accessToken = localStorage.getItem('spotify_access_token');
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            const tokenExpires = localStorage.getItem('spotify_token_expires');
            
            let tokensHtml = '';
            if (accessToken) {
                const isExpired = tokenExpires && Date.now() > parseInt(tokenExpires);
                const timeLeft = tokenExpires ? Math.floor((parseInt(tokenExpires) - Date.now()) / 1000) : 0;
                
                tokensHtml = `
                    ‚úÖ Access Token: Disponible
                    ${isExpired ? '‚ö†Ô∏è' : '‚úÖ'} Expiraci√≥n: ${isExpired ? 'Expirado' : `${timeLeft}s restantes`}
                    ${refreshToken ? '‚úÖ' : '‚ùå'} Refresh Token: ${refreshToken ? 'Disponible' : 'No disponible'}
                `;
                updateStatus('tokens-status', tokensHtml, isExpired ? 'warning' : 'success');
                log(`Tokens: Access=${!!accessToken}, Refresh=${!!refreshToken}, Expired=${isExpired}`);
            } else {
                tokensHtml = '‚ùå No hay tokens disponibles';
                updateStatus('tokens-status', tokensHtml, 'error');
                log('No hay tokens disponibles', 'error');
            }
        }
        
        async function checkNetwork() {
            log('Verificando conectividad...');
            
            try {
                const response = await fetch('https://api.spotify.com/v1', {
                    method: 'HEAD',
                    signal: AbortSignal.timeout(5000)
                });
                
                let networkHtml = '';
                if (response.ok || response.status === 401) {
                    networkHtml = '‚úÖ Conectividad con Spotify disponible';
                    updateStatus('network-status', networkHtml, 'success');
                    log('Conectividad con Spotify: OK');
                } else {
                    networkHtml = `‚ö†Ô∏è Conectividad limitada: ${response.status}`;
                    updateStatus('network-status', networkHtml, 'warning');
                    log(`Conectividad con Spotify: ${response.status}`, 'warning');
                }
            } catch (error) {
                const networkHtml = '‚ùå Sin conectividad con Spotify';
                updateStatus('network-status', networkHtml, 'error');
                log(`Error de conectividad: ${error.message}`, 'error');
            }
        }
        
        async function testConfig() {
            log('Probando configuraci√≥n...');
            
            if (!window.config) {
                log('Configuraci√≥n no disponible', 'error');
                return;
            }
            
            try {
                // Probar URL de autenticaci√≥n
                const authUrl = new URL(window.config.authUrl);
                log('URL de autenticaci√≥n v√°lida');
                
                // Probar scopes
                if (window.config.scopes && window.config.scopes.length > 0) {
                    log(`Scopes v√°lidos: ${window.config.scopes.length} permisos`);
                } else {
                    log('No hay scopes configurados', 'warning');
                }
                
                log('Configuraci√≥n v√°lida', 'success');
            } catch (error) {
                log(`Error en configuraci√≥n: ${error.message}`, 'error');
            }
        }
        
        async function testNetwork() {
            log('Probando conectividad...');
            await checkNetwork();
        }
        
        async function testAuth() {
            log('Probando autenticaci√≥n...');
            
            if (!window.config) {
                log('Configuraci√≥n no disponible para prueba de auth', 'error');
                return;
            }
            
            try {
                const state = Math.random().toString(36).substring(2, 15);
                const params = new URLSearchParams({
                    client_id: window.config.clientId,
                    response_type: 'code',
                    redirect_uri: window.config.redirectUri,
                    state: state,
                    scope: window.config.scopes.join(' '),
                    show_dialog: 'true'
                });
                
                const authUrl = `${window.config.authUrl}?${params.toString()}`;
                log(`URL de autenticaci√≥n generada: ${authUrl}`);
                
                // Verificar que la URL sea v√°lida
                new URL(authUrl);
                log('URL de autenticaci√≥n v√°lida', 'success');
                
                // Simular redirecci√≥n (sin ejecutar)
                log('Prueba de autenticaci√≥n exitosa - URL v√°lida generada');
                
            } catch (error) {
                log(`Error en prueba de auth: ${error.message}`, 'error');
            }
        }
        
        function clearTokens() {
            log('Limpiando tokens...');
            
            localStorage.removeItem('spotify_access_token');
            localStorage.removeItem('spotify_token_expires');
            localStorage.removeItem('spotify_refresh_token');
            localStorage.removeItem('spotify_auth_state');
            
            log('Tokens limpiados', 'success');
            refreshStatus();
        }
        
        function refreshPage() {
            log('Recargando p√°gina...');
            window.location.reload();
        }
        
        function refreshStatus() {
            checkCurrentStatus();
            checkConfig();
            checkTokens();
            checkNetwork();
        }
        
        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', () => {
            log('P√°gina de debug cargada');
            refreshStatus();
            
            // Actualizar estado cada 5 segundos
            setInterval(refreshStatus, 5000);
        });
        
        // Interceptar errores globales
        window.addEventListener('error', (event) => {
            log(`Error global: ${event.error?.message || event.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            log(`Promesa rechazada: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>
