<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Inicio de Sesi√≥n - Tuneuptify</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(20, 20, 20, 0.95);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .debug-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .debug-title {
            color: #1db954;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border-left: 4px solid transparent;
        }
        .status-success {
            border-left-color: #1db954;
        }
        .status-error {
            border-left-color: #e74c3c;
        }
        .status-warning {
            border-left-color: #f39c12;
        }
        .status-info {
            border-left-color: #3498db;
        }
        .status-label {
            font-weight: 600;
            color: #ffffff;
        }
        .status-value {
            color: #b3b3b3;
            font-family: monospace;
        }
        .action-btn {
            background: linear-gradient(135deg, #1db954, #1ed760);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(29, 185, 84, 0.3);
        }
        .action-btn.secondary {
            background: linear-gradient(135deg, #535353, #666);
        }
        .action-btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .log-entry {
            margin: 0.25rem 0;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .log-success { color: #1db954; }
        .log-error { color: #e74c3c; }
        .log-warning { color: #f39c12; }
        .log-info { color: #3498db; }
        .test-result {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .test-success {
            background: rgba(29, 185, 84, 0.1);
            border-left-color: #1db954;
        }
        .test-error {
            background: rgba(231, 76, 60, 0.1);
            border-left-color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1 style="text-align: center; color: #1db954; margin-bottom: 2rem;">
            üîç Diagn√≥stico de Inicio de Sesi√≥n
        </h1>

        <!-- Estado de Autenticaci√≥n -->
        <div class="debug-section">
            <h2 class="debug-title">
                <i class="fas fa-user-check"></i>
                Estado de Autenticaci√≥n
            </h2>
            <div id="auth-status"></div>
        </div>

        <!-- Configuraci√≥n -->
        <div class="debug-section">
            <h2 class="debug-title">
                <i class="fas fa-cog"></i>
                Configuraci√≥n
            </h2>
            <div id="config-status"></div>
        </div>

        <!-- Tokens -->
        <div class="debug-section">
            <h2 class="debug-title">
                <i class="fas fa-key"></i>
                Tokens
            </h2>
            <div id="token-status"></div>
        </div>

        <!-- Pruebas de API -->
        <div class="debug-section">
            <h2 class="debug-title">
                <i class="fas fa-network-wired"></i>
                Pruebas de API
            </h2>
            <div id="api-tests">
                <button class="action-btn" onclick="testSpotifyAPI()">
                    <i class="fas fa-play"></i>
                    Probar API de Spotify
                </button>
                <button class="action-btn secondary" onclick="testAuthFlow()">
                    <i class="fas fa-sign-in-alt"></i>
                    Probar Flujo de Autenticaci√≥n
                </button>
                <button class="action-btn danger" onclick="clearAllTokens()">
                    <i class="fas fa-trash"></i>
                    Limpiar Todos los Tokens
                </button>
            </div>
            <div id="api-results"></div>
        </div>

        <!-- Logs -->
        <div class="debug-section">
            <h2 class="debug-title">
                <i class="fas fa-list"></i>
                Logs de Diagn√≥stico
            </h2>
            <div class="log-container" id="debug-logs"></div>
        </div>

        <!-- Acciones -->
        <div class="debug-section">
            <h2 class="debug-title">
                <i class="fas fa-tools"></i>
                Acciones de Reparaci√≥n
            </h2>
            <button class="action-btn" onclick="repairAuth()">
                <i class="fas fa-wrench"></i>
                Reparar Autenticaci√≥n
            </button>
            <button class="action-btn secondary" onclick="forceLogin()">
                <i class="fas fa-sign-in-alt"></i>
                Forzar Nuevo Login
            </button>
            <button class="action-btn" onclick="refreshTokens()">
                <i class="fas fa-sync"></i>
                Refrescar Tokens
            </button>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script>
        let debugLogs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLogs.push({ message: logEntry, type });
            
            const logsContainer = document.getElementById('debug-logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = logEntry;
            logsContainer.appendChild(entry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
            
            console.log(`[DEBUG] ${logEntry}`);
        }

        function updateStatus(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            items.forEach(item => {
                const statusItem = document.createElement('div');
                statusItem.className = `status-item status-${item.status}`;
                statusItem.innerHTML = `
                    <span class="status-label">${item.label}</span>
                    <span class="status-value">${item.value}</span>
                `;
                container.appendChild(statusItem);
            });
        }

        function checkAuthStatus() {
            const accessToken = localStorage.getItem('spotify_access_token');
            const tokenExpires = localStorage.getItem('spotify_token_expires');
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            const authState = localStorage.getItem('spotify_auth_state');

            const authItems = [
                {
                    label: 'Token de Acceso',
                    value: accessToken ? '‚úÖ Presente' : '‚ùå Ausente',
                    status: accessToken ? 'success' : 'error'
                },
                {
                    label: 'Expiraci√≥n del Token',
                    value: tokenExpires ? new Date(parseInt(tokenExpires)).toLocaleString() : '‚ùå No configurado',
                    status: tokenExpires ? 'info' : 'error'
                },
                {
                    label: 'Token V√°lido',
                    value: accessToken && tokenExpires && Date.now() < parseInt(tokenExpires) ? '‚úÖ V√°lido' : '‚ùå Expirado/Inv√°lido',
                    status: accessToken && tokenExpires && Date.now() < parseInt(tokenExpires) ? 'success' : 'error'
                },
                {
                    label: 'Token de Refresco',
                    value: refreshToken ? '‚úÖ Presente' : '‚ùå Ausente',
                    status: refreshToken ? 'success' : 'warning'
                },
                {
                    label: 'Estado de Autenticaci√≥n',
                    value: authState ? '‚úÖ Configurado' : '‚ùå No configurado',
                    status: authState ? 'info' : 'warning'
                }
            ];

            updateStatus('auth-status', authItems);
            log('Estado de autenticaci√≥n verificado', 'info');
        }

        function checkConfig() {
            const configItems = [
                {
                    label: 'Client ID',
                    value: window.config?.clientId ? '‚úÖ Configurado' : '‚ùå No configurado',
                    status: window.config?.clientId ? 'success' : 'error'
                },
                {
                    label: 'Redirect URI',
                    value: window.config?.redirectUri || '‚ùå No configurado',
                    status: window.config?.redirectUri ? 'info' : 'error'
                },
                {
                    label: 'Entorno',
                    value: window.config?.isGitHubPages ? 'üåê GitHub Pages' : 'üíª Local',
                    status: 'info'
                },
                {
                    label: 'Scopes',
                    value: window.config?.scopes?.length ? `${window.config.scopes.length} scopes` : '‚ùå No configurados',
                    status: window.config?.scopes?.length ? 'success' : 'error'
                }
            ];

            updateStatus('config-status', configItems);
            log('Configuraci√≥n verificada', 'info');
        }

        function checkTokens() {
            const accessToken = localStorage.getItem('spotify_access_token');
            const tokenExpires = localStorage.getItem('spotify_token_expires');
            const refreshToken = localStorage.getItem('spotify_refresh_token');

            const tokenItems = [
                {
                    label: 'Token de Acceso',
                    value: accessToken ? `${accessToken.substring(0, 20)}...` : '‚ùå No disponible',
                    status: accessToken ? 'success' : 'error'
                },
                {
                    label: 'Tiempo Restante',
                    value: tokenExpires ? `${Math.max(0, Math.floor((parseInt(tokenExpires) - Date.now()) / 1000 / 60))} minutos` : '‚ùå No disponible',
                    status: tokenExpires && Date.now() < parseInt(tokenExpires) ? 'success' : 'error'
                },
                {
                    label: 'Token de Refresco',
                    value: refreshToken ? `${refreshToken.substring(0, 20)}...` : '‚ùå No disponible',
                    status: refreshToken ? 'success' : 'warning'
                }
            ];

            updateStatus('token-status', tokenItems);
            log('Tokens verificados', 'info');
        }

        async function testSpotifyAPI() {
            log('Iniciando prueba de API de Spotify...', 'info');
            
            const accessToken = localStorage.getItem('spotify_access_token');
            if (!accessToken) {
                log('‚ùå No hay token de acceso para probar la API', 'error');
                return;
            }

            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ API de Spotify funcionando correctamente', 'success');
                    log(`Usuario: ${data.display_name} (${data.id})`, 'info');
                    
                    const resultsContainer = document.getElementById('api-results');
                    resultsContainer.innerHTML = `
                        <div class="test-result test-success">
                            <h4>‚úÖ Prueba de API Exitosa</h4>
                            <p><strong>Usuario:</strong> ${data.display_name}</p>
                            <p><strong>ID:</strong> ${data.id}</p>
                            <p><strong>Email:</strong> ${data.email || 'No disponible'}</p>
                        </div>
                    `;
                } else {
                    log(`‚ùå Error en API: ${response.status} ${response.statusText}`, 'error');
                    
                    const resultsContainer = document.getElementById('api-results');
                    resultsContainer.innerHTML = `
                        <div class="test-result test-error">
                            <h4>‚ùå Error en API de Spotify</h4>
                            <p><strong>Status:</strong> ${response.status} ${response.statusText}</p>
                            <p>El token puede estar expirado o ser inv√°lido.</p>
                        </div>
                    `;
                }
            } catch (error) {
                log(`‚ùå Error de red: ${error.message}`, 'error');
            }
        }

        function testAuthFlow() {
            log('Iniciando prueba de flujo de autenticaci√≥n...', 'info');
            
            if (!window.config) {
                log('‚ùå Configuraci√≥n no disponible', 'error');
                return;
            }

            const state = Math.random().toString(36).substring(2, 15);
            localStorage.setItem('spotify_auth_state', state);

            const params = new URLSearchParams({
                client_id: window.config.clientId,
                response_type: 'code',
                redirect_uri: window.config.redirectUri,
                state: state,
                scope: window.config.scopes.join(' '),
                show_dialog: 'true'
            });

            const authUrl = `${window.config.authUrl}?${params.toString()}`;
            log(`‚úÖ URL de autenticaci√≥n generada: ${authUrl}`, 'success');
            
            const resultsContainer = document.getElementById('api-results');
            resultsContainer.innerHTML = `
                <div class="test-result test-success">
                    <h4>‚úÖ Flujo de Autenticaci√≥n Preparado</h4>
                    <p><strong>Client ID:</strong> ${window.config.clientId}</p>
                    <p><strong>Redirect URI:</strong> ${window.config.redirectUri}</p>
                    <p><strong>Scopes:</strong> ${window.config.scopes.join(', ')}</p>
                    <button class="action-btn" onclick="window.open('${authUrl}', '_blank')">
                        <i class="fas fa-external-link-alt"></i>
                        Abrir URL de Autenticaci√≥n
                    </button>
                </div>
            `;
        }

        function clearAllTokens() {
            if (confirm('¬øEst√°s seguro de que quieres limpiar todos los tokens? Esto cerrar√° la sesi√≥n.')) {
                localStorage.removeItem('spotify_access_token');
                localStorage.removeItem('spotify_token_expires');
                localStorage.removeItem('spotify_refresh_token');
                localStorage.removeItem('spotify_auth_state');
                
                log('‚úÖ Todos los tokens han sido limpiados', 'success');
                checkAuthStatus();
                checkTokens();
            }
        }

        function repairAuth() {
            log('Iniciando reparaci√≥n de autenticaci√≥n...', 'info');
            
            // Limpiar tokens expirados
            const tokenExpires = localStorage.getItem('spotify_token_expires');
            if (tokenExpires && Date.now() > parseInt(tokenExpires)) {
                localStorage.removeItem('spotify_access_token');
                localStorage.removeItem('spotify_token_expires');
                log('‚úÖ Tokens expirados eliminados', 'success');
            }
            
            // Verificar configuraci√≥n
            if (!window.config) {
                log('‚ùå Configuraci√≥n no disponible, recargando p√°gina...', 'error');
                setTimeout(() => window.location.reload(), 1000);
                return;
            }
            
            log('‚úÖ Reparaci√≥n completada', 'success');
            checkAuthStatus();
            checkTokens();
        }

        function forceLogin() {
            log('Forzando nuevo login...', 'info');
            clearAllTokens();
            window.location.href = 'index.html';
        }

        async function refreshTokens() {
            log('Intentando refrescar tokens...', 'info');
            
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            if (!refreshToken) {
                log('‚ùå No hay token de refresco disponible', 'error');
                return;
            }

            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(window.config.clientId + ':' + window.config.clientSecret)
                    },
                    body: new URLSearchParams({
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('spotify_access_token', data.access_token);
                    localStorage.setItem('spotify_token_expires', Date.now() + (data.expires_in * 1000));
                    
                    if (data.refresh_token) {
                        localStorage.setItem('spotify_refresh_token', data.refresh_token);
                    }
                    
                    log('‚úÖ Tokens refrescados exitosamente', 'success');
                    checkAuthStatus();
                    checkTokens();
                } else {
                    log('‚ùå Error al refrescar tokens', 'error');
                }
            } catch (error) {
                log(`‚ùå Error de red: ${error.message}`, 'error');
            }
        }

        // Inicializar diagn√≥stico
        document.addEventListener('DOMContentLoaded', () => {
            log('üîç Iniciando diagn√≥stico de inicio de sesi√≥n...', 'info');
            checkAuthStatus();
            checkConfig();
            checkTokens();
            log('‚úÖ Diagn√≥stico completado', 'success');
        });
    </script>
</body>
</html> 