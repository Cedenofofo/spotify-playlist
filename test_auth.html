<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Autenticación - Tuneuptify</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(20, 20, 20, 0.95);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .test-title {
            color: #1db954;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        .test-button {
            background: linear-gradient(135deg, #1db954, #1ed760);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(29, 185, 84, 0.3);
        }
        .test-button.secondary {
            background: linear-gradient(135deg, #535353, #666);
        }
        .test-button.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        .status-display {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-success { color: #1db954; }
        .status-error { color: #e74c3c; }
        .status-warning { color: #f39c12; }
        .status-info { color: #3498db; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 Test de Autenticación - Tuneuptify</h1>
        
        <div class="test-section">
            <h2 class="test-title">📋 Estado Actual</h2>
            <div id="current-status" class="status-display">Cargando estado...</div>
            <button class="test-button" onclick="checkCurrentStatus()">🔄 Actualizar Estado</button>
        </div>

        <div class="test-section">
            <h2 class="test-title">🔑 Pruebas de Autenticación</h2>
            <button class="test-button" onclick="testLogin()">🚀 Probar Login</button>
            <button class="test-button secondary" onclick="testLogout()">🚪 Probar Logout</button>
            <button class="test-button" onclick="testTokenRefresh()">🔄 Probar Refresh Token</button>
            <button class="test-button danger" onclick="clearAllData()">🗑️ Limpiar Datos</button>
        </div>

        <div class="test-section">
            <h2 class="test-title">🌐 Pruebas de API</h2>
            <button class="test-button" onclick="testSpotifyAPI()">🎵 Probar API Spotify</button>
            <button class="test-button" onclick="testUserProfile()">👤 Probar Perfil Usuario</button>
            <button class="test-button" onclick="testPlaylists()">📝 Probar Playlists</button>
        </div>

        <div class="test-section">
            <h2 class="test-title">⚙️ Configuración</h2>
            <div id="config-status" class="status-display">Cargando configuración...</div>
            <button class="test-button" onclick="checkConfig()">🔧 Verificar Config</button>
        </div>

        <div class="test-section">
            <h2 class="test-title">📊 Logs de Prueba</h2>
            <div id="test-logs" class="status-display">Los logs aparecerán aquí...</div>
            <button class="test-button secondary" onclick="clearLogs()">🧹 Limpiar Logs</button>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let authInstance;

        // Función para agregar logs
        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('test-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `status-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Función para limpiar logs
        function clearLogs() {
            document.getElementById('test-logs').innerHTML = 'Los logs aparecerán aquí...';
        }

        // Verificar estado actual
        function checkCurrentStatus() {
            const statusDiv = document.getElementById('current-status');
            let status = '';

            // Verificar configuración
            if (window.config) {
                status += '✅ Configuración cargada\n';
                status += `Client ID: ${window.config.clientId}\n`;
                status += `Redirect URI: ${window.config.redirectUri}\n`;
            } else {
                status += '❌ Configuración no encontrada\n';
            }

            // Verificar tokens
            const accessToken = localStorage.getItem('spotify_access_token');
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            const tokenExpires = localStorage.getItem('spotify_token_expires');

            if (accessToken) {
                status += '✅ Token de acceso encontrado\n';
                status += `Token: ${accessToken.substring(0, 20)}...\n`;
            } else {
                status += '❌ No hay token de acceso\n';
            }

            if (refreshToken) {
                status += '✅ Token de refresh encontrado\n';
            } else {
                status += '⚠️ No hay token de refresh\n';
            }

            if (tokenExpires) {
                const expiresDate = new Date(parseInt(tokenExpires));
                const now = new Date();
                if (now < expiresDate) {
                    status += `✅ Token válido (expira: ${expiresDate.toLocaleString()})\n`;
                } else {
                    status += `❌ Token expirado (expiró: ${expiresDate.toLocaleString()})\n`;
                }
            } else {
                status += '❌ No hay fecha de expiración\n';
            }

            statusDiv.textContent = status;
            addLog('Estado actual verificado', 'success');
        }

        // Probar login
        function testLogin() {
            addLog('Iniciando prueba de login...', 'info');
            if (authInstance) {
                authInstance.login();
                addLog('Login iniciado', 'success');
            } else {
                addLog('Error: Instancia de Auth no disponible', 'error');
            }
        }

        // Probar logout
        function testLogout() {
            addLog('Iniciando prueba de logout...', 'info');
            if (authInstance) {
                authInstance.logout();
                addLog('Logout ejecutado', 'success');
            } else {
                addLog('Error: Instancia de Auth no disponible', 'error');
            }
        }

        // Probar refresh token
        async function testTokenRefresh() {
            addLog('Iniciando prueba de refresh token...', 'info');
            const refreshToken = localStorage.getItem('spotify_refresh_token');
            
            if (!refreshToken) {
                addLog('Error: No hay refresh token disponible', 'error');
                return;
            }

            if (authInstance) {
                try {
                    await authInstance.refreshAccessToken(refreshToken);
                    addLog('Refresh token ejecutado exitosamente', 'success');
                } catch (error) {
                    addLog(`Error en refresh token: ${error.message}`, 'error');
                }
            } else {
                addLog('Error: Instancia de Auth no disponible', 'error');
            }
        }

        // Limpiar todos los datos
        function clearAllData() {
            addLog('Limpiando todos los datos...', 'warning');
            localStorage.clear();
            sessionStorage.clear();
            addLog('Datos limpiados', 'success');
            checkCurrentStatus();
        }

        // Probar API de Spotify
        async function testSpotifyAPI() {
            addLog('Probando API de Spotify...', 'info');
            const token = localStorage.getItem('spotify_access_token');
            
            if (!token) {
                addLog('Error: No hay token de acceso', 'error');
                return;
            }

            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    addLog(`API funcionando - Usuario: ${data.display_name}`, 'success');
                } else {
                    addLog(`Error API: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`Error de red: ${error.message}`, 'error');
            }
        }

        // Probar perfil de usuario
        async function testUserProfile() {
            addLog('Probando perfil de usuario...', 'info');
            const token = localStorage.getItem('spotify_access_token');
            
            if (!token) {
                addLog('Error: No hay token de acceso', 'error');
                return;
            }

            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    addLog(`Perfil cargado - ${data.display_name} (${data.email})`, 'success');
                } else {
                    addLog(`Error perfil: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`Error de red: ${error.message}`, 'error');
            }
        }

        // Probar playlists
        async function testPlaylists() {
            addLog('Probando playlists...', 'info');
            const token = localStorage.getItem('spotify_access_token');
            
            if (!token) {
                addLog('Error: No hay token de acceso', 'error');
                return;
            }

            try {
                const response = await fetch('https://api.spotify.com/v1/me/playlists?limit=5', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    addLog(`Playlists encontradas: ${data.items.length}`, 'success');
                } else {
                    addLog(`Error playlists: ${response.status}`, 'error');
                }
            } catch (error) {
                addLog(`Error de red: ${error.message}`, 'error');
            }
        }

        // Verificar configuración
        function checkConfig() {
            addLog('Verificando configuración...', 'info');
            const configDiv = document.getElementById('config-status');
            let config = '';

            if (window.config) {
                config += '✅ Configuración disponible\n';
                config += `Client ID: ${window.config.clientId}\n`;
                config += `Redirect URI: ${window.config.redirectUri}\n`;
                config += `Scopes: ${window.config.scopes.join(', ')}\n`;
                config += `Base URL: ${window.config.baseUrl}\n`;
                config += `GitHub Pages: ${window.config.isGitHubPages}\n`;
                addLog('Configuración verificada correctamente', 'success');
            } else {
                config += '❌ Configuración no disponible\n';
                addLog('Error: Configuración no encontrada', 'error');
            }

            configDiv.textContent = config;
        }

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            addLog('Página de prueba cargada', 'info');
            
            // Crear instancia de Auth
            authInstance = new Auth();
            
            // Verificar estado inicial
            setTimeout(() => {
                checkCurrentStatus();
                checkConfig();
            }, 1000);
        });
    </script>
</body>
</html> 